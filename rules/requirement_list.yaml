# 小智 ESP32 微信小程序 BLE 配网需求与验收清单

## I. 设备端 (ESP32 Firmware - xiaozhi-esp32 项目)

### **A. 基础环境与配置**

#### **A1. ESP-IDF 配置**
- **需求描述**:
  - A1.1. 启用蓝牙 (Bluetooth)。
  - A1.2. 选择 NimBLE 作为蓝牙 Host 协议栈。
  - A1.3. 启用 BLE Peripheral (外围设备) 角色，包含 GATT Server (GATTS)。
  - A1.4. 配置 NimBLE 资源限制（如最大连接数、服务/特征值数量）。
  - A1.5. 确保 NVS (非易失性存储) 功能已启用，用于存储 Wi-Fi 凭据。
- **验收条件**:
  - 通过 `menuconfig` 确认蓝牙、NimBLE、GATTS、NVS 功能已启用。
  - 编译后固件中蓝牙协议栈初始化日志无报错。
  - 日志显示 NimBLE 资源限制配置与实际设置一致（如 `BLE_MAX_CONNECTIONS=1`）。
  - NVS 读写测试通过（写入后重启可读取到正确数据）。

#### **A2. 项目构建配置**
- **需求描述**:
  - A2.1. 在 `main/CMakeLists.txt` 中添加 BLE 配网相关源文件 (`ble_config.cc`)。
  - A2.2. 在 `main/CMakeLists.txt` 中添加 BLE 配网相关头文件目录 (`ble_config`) 到包含路径。
- **验收条件**:
  - 编译系统无缺失文件错误，`ble_config.cc` 参与编译。
  - IDE 或编译器可正常跳转到 `ble_config` 目录下的头文件。

---

### **B. 未联网语音提示**

#### **B1. 音频资源**
- **需求描述**:
  - B1.1. 制作包含提示语“电源已接通...”的音频文件。
  - B1.2. 将音频文件转换为 `.p3` 格式。
  - B1.3. 文件放置到 `D:\1117\...\zh-CN` 目录。
  - B1.4. 确保 `.p3` 文件被 `EMBED_FILES` 包含并在 `lang_config.h` 中生成引用。
- **验收条件**:
  - 指定目录中存在 `.p3` 文件且文件名正确。
  - 编译后固件大小增加与音频文件体积一致。
  - 调用 `play_audio("prompt_network")` 可播放正确语音。

#### **B2. 触发逻辑**
- **需求描述**:
  - B2.1. 启动时检查 NVS 中是否存在 Wi-Fi 配置。
  - B2.2. 未配置时调用音频播放接口。
  - B2.3. 处理 Wi-Fi 连接失败时的提示逻辑。
- **验收条件**:
  - 首次上电（NVS 无 SSID）自动播放提示音。
  - 已配置 Wi-Fi 时无语音提示。
  - 模拟 Wi-Fi 连接失败后播放指定错误提示音（如有）。

---

### **C. BLE 功能实现 (`ble_config` 模块)**

#### **C1. BLE 初始化**
- **需求描述**:
  - C1.1. 实现 `BleConfig::Initialize()` 初始化协议栈、GATT 服务等。
- **验收条件**:
  - 日志显示 `nimble_port_init()` 调用成功。
  - BLE 设备名称可被手机扫描到（如 "xiaozhi-ble"）。
  - 使用 BLE 调试工具可发现完整的 GATT 服务列表。

#### **C2. BLE 广播**
- **需求描述**:
  - C2.1. 配置广播参数及数据包（包含服务 UUID 和设备名称）。
  - C2.2. 实现广播启停控制接口。
- **验收条件**:
  - 使用 `nRF Connect` 等工具可扫描到设备广播，广播间隔为 100-500ms。
  - 连接建立后广播停止，断开后自动重启。
  - 广播数据包中包含完整的服务 UUID `0xCDB7...DBD63`。

---

### **D. 应用逻辑集成**
#### **D3. 回调实现**
- **需求描述**:
  - D3.1. 设置回调接口 `SetCredentialsReceivedCallback`。
  - D3.2. 触发 `WifiStation::Connect` 连接 Wi-Fi。
- **验收条件**:
  - 小程序写入 SSID/Password 后，日志显示回调被触发且数据正确。
  - 调用 `WifiStation::Connect` 后，ESP32 尝试连接指定 Wi-Fi 并记录日志。

---

## II. 微信小程序端

### **E. 基础架构与 UI/UX**
#### **E2. 页面设计**
- **需求描述**:
  - E2.1. 引导页说明配网流程。
  - E2.4. 密码输入页支持明文/密文切换。
- **验收条件**:
  - 页面布局与设计稿一致，文字无错别字。
  - 密码输入框默认隐藏内容，点击眼睛图标可切换显示。

---

### **F. BLE 核心功能**
#### **F3. 设备扫描**
- **需求描述**:
  - F3.1. 开始扫描并过滤服务 UUID。
  - F3.2. 监听设备发现事件并更新列表。
- **验收条件**:
  - 仅显示名称为 "xiaozhi-ble" 或包含目标 UUID 的设备。
  - 设备列表刷新频率 ≤2秒，无重复条目。

#### **F6. 数据写入**
- **需求描述**:
  - F6.1. 向 SSID/Password 特征值写入数据（支持分包）。
- **验收条件**:
  - 输入 32 字节长 SSID 可成功写入（日志显示完整数据）。
  - 写入失败时弹出 Toast 提示（如 "写入超时"）。

---

## **全局验收标准**
1. **功能完整性**：所有需求项均有对应验收条件且测试通过。
2. **健壮性**：模拟断网、蓝牙断开等异常场景，系统能自动恢复或提示。
3. **性能**：从设备上电到小程序显示配网成功 ≤90秒。
4. **兼容性**：Android/iOS 主流机型（测试列表）均能完成配网。

---

**说明**：  
- 每个需求点下方直接关联其验收条件，确保可追溯性。  
- 验收条件包含**具体验证方法**（如工具名称、日志关键字）和**量化指标**（如超时时间）。  
- 全局标准作为整体项目验收的补充约束。